name: Apply ZIP (CineSafari)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo layout (debug)
        run: |
          set -e
          echo "Repo root:"
          ls -la
          echo ""
          echo "imports/ (if present):"
          ls -la imports || true
          echo ""
          echo "import/ (if present):"
          ls -la import || true

      - name: Locate CineSafari ZIP (supports import/ or imports/)
        id: findzip
        run: |
          set -euo pipefail

          ZIP=""
          if [ -f "imports/cinesafari-project.zip" ]; then
            ZIP="imports/cinesafari-project.zip"
          elif [ -f "import/cinesafari-project.zip" ]; then
            ZIP="import/cinesafari-project.zip"
          else
            echo "❌ ZIP not found in imports/ or import/"
            echo "Found in imports/:"
            ls -la imports || true
            echo "Found in import/:"
            ls -la import || true
            exit 1
          fi

          echo "✅ Using ZIP: $ZIP"
          echo "zip_path=$ZIP" >> "$GITHUB_OUTPUT"

      - name: Unzip into tmp/
        run: |
          set -euo pipefail
          rm -rf tmp/applyzip
          mkdir -p tmp/applyzip
          unzip -q "${{ steps.findzip.outputs.zip_path }}" -d tmp/applyzip

          echo "Top of extracted ZIP:"
          ls -la tmp/applyzip | head -n 200

      - name: Detect project root inside ZIP (handles nested folder zips)
        id: zroot
        run: |
          set -euo pipefail

          ROOT="tmp/applyzip"

          # If it extracted a single top folder, step into it
          top_count=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | wc -l | tr -d ' ')
          file_count=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type f | wc -l | tr -d ' ')

          if [ "$top_count" -eq 1 ] && [ "$file_count" -eq 0 ]; then
            ROOT=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1)
          fi

          # Some GitHub artifacts create extra nesting; walk down until we see package.json or src/
          for i in 1 2 3 4 5; do
            if [ -f "$ROOT/package.json" ] || [ -d "$ROOT/src" ]; then
              break
            fi
            next=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1 || true)
            if [ -z "$next" ]; then
              break
            fi
            ROOT="$next"
          done

          echo "Detected ZIP project root: $ROOT"
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"

          echo "Root listing:"
          ls -la "$ROOT" | head -n 200

      - name: Apply extracted files into repo (excluding .git and .github)
        run: |
          set -euo pipefail
          ROOT="${{ steps.zroot.outputs.root }}"

          # Copy everything from ZIP root into repo root, but keep repo workflow files
          rsync -a --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            "$ROOT/" "./"

          echo "✅ Applied ZIP contents to repo working tree."

      - name: Install dependencies (npm ci if lockfile exists)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build (Vite)
        run: |
          set -euo pipefail
          npm run build

      - name: Commit and push changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Apply CineSafari ZIP update"
          git push
