name: Apply ZIP (CineSafari)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug repo layout
        run: |
          set -e
          echo "Repo root:"
          ls -la
          echo ""
          echo "imports/:"
          ls -la imports || true
          echo ""
          echo "import/:"
          ls -la import || true

      - name: Locate CineSafari ZIP (imports/ or import/)
        id: findzip
        run: |
          set -euo pipefail
          if [ -f "imports/cinesafari-project.zip" ]; then
            echo "zip_path=imports/cinesafari-project.zip" >> "$GITHUB_OUTPUT"
          elif [ -f "import/cinesafari-project.zip" ]; then
            echo "zip_path=import/cinesafari-project.zip" >> "$GITHUB_OUTPUT"
          else
            echo "❌ ZIP not found"
            echo "imports/:"
            ls -la imports || true
            echo "import/:"
            ls -la import || true
            exit 1
          fi
          echo "✅ ZIP found: ${{ steps.findzip.outputs.zip_path }}"

      - name: Unzip into tmp/unzip
        run: |
          set -euo pipefail
          rm -rf tmp/unzip tmp/stage
          mkdir -p tmp/unzip tmp/stage
          unzip -q "${{ steps.findzip.outputs.zip_path }}" -d tmp/unzip
          echo "Unzip listing (top):"
          ls -la tmp/unzip | head -n 200

      - name: Detect project root inside ZIP
        id: zroot
        run: |
          set -euo pipefail

          ROOT="tmp/unzip"

          # If single top folder, step into it
          top_dirs=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | wc -l | tr -d ' ')
          top_files=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type f | wc -l | tr -d ' ')
          if [ "$top_dirs" -eq 1 ] && [ "$top_files" -eq 0 ]; then
            ROOT=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1)
          fi

          # Walk down until we see a project marker
          for i in 1 2 3 4 5; do
            if [ -f "$ROOT/package.json" ] || [ -d "$ROOT/src" ]; then
              break
            fi
            NEXT=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1 || true)
            if [ -z "$NEXT" ]; then
              break
            fi
            ROOT="$NEXT"
          done

          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "✅ Detected ZIP project root: $ROOT"
          echo "Root listing:"
          ls -la "$ROOT" | head -n 200

      - name: Stage ZIP contents (stable snapshot)
        run: |
          set -euo pipefail
          ROOT="${{ steps.zroot.outputs.root }}"

          # Copy into a stable staging area so rsync source doesn't change mid-transfer
          cp -a "$ROOT/." tmp/stage/

          echo "Stage listing (top):"
          ls -la tmp/stage | head -n 200

          # Validate stage has expected markers
          test -f tmp/stage/package.json
          test -d tmp/stage/src

      - name: Apply staged files into repo (keep .github + imports)
        run: |
          set -euo pipefail

          # rsync from stage -> repo root
          # - excludes workflows + imports stash folder
          # - --delete keeps repo clean, but won't touch excluded paths
          set +e
          rsync -a --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "imports/" \
            tmp/stage/ ./
          code=$?
          set -e

          # rsync code 24 = "vanished files" warning; we avoid it via staging, but retry once if it happens
          if [ "$code" -eq 24 ]; then
            echo "⚠️ rsync warning code 24 (vanished files). Retrying once..."
            rsync -a --delete \
              --exclude ".git/" \
              --exclude ".github/" \
              --exclude "imports/" \
              tmp/stage/ ./
          elif [ "$code" -ne 0 ]; then
            echo "❌ rsync failed with code $code"
            exit "$code"
          fi

          echo "✅ Applied ZIP contents to repo."

      - name: Install dependencies
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        run: |
          set -euo pipefail
          npm run build

      - name: Commit and push changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Apply CineSafari ZIP update"
          git push
