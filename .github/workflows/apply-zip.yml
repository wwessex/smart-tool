name: Apply ZIP (CineSafari)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate CineSafari ZIP (imports/ or import/)
        id: findzip
        run: |
          set -euo pipefail
          if [ -f "imports/cinesafari-project.zip" ]; then
            echo "zip_path=imports/cinesafari-project.zip" >> "$GITHUB_OUTPUT"
          elif [ -f "import/cinesafari-project.zip" ]; then
            echo "zip_path=import/cinesafari-project.zip" >> "$GITHUB_OUTPUT"
          else
            echo "❌ ZIP not found"
            echo "imports/:"
            ls -la imports || true
            echo "import/:"
            ls -la import || true
            exit 1
          fi
          echo "✅ ZIP: ${{ steps.findzip.outputs.zip_path }}"

      - name: Unzip into RUNNER_TEMP
        id: unzip
        run: |
          set -euo pipefail
          UNZIP_DIR="${RUNNER_TEMP}/cinesafari_unzip"
          STAGE_DIR="${RUNNER_TEMP}/cinesafari_stage"
          rm -rf "$UNZIP_DIR" "$STAGE_DIR"
          mkdir -p "$UNZIP_DIR" "$STAGE_DIR"

          unzip -q "${{ steps.findzip.outputs.zip_path }}" -d "$UNZIP_DIR"

          echo "unzip_dir=$UNZIP_DIR" >> "$GITHUB_OUTPUT"
          echo "stage_dir=$STAGE_DIR" >> "$GITHUB_OUTPUT"

          echo "Top of unzip:"
          ls -la "$UNZIP_DIR" | head -n 200

      - name: Detect project root inside ZIP
        id: zroot
        run: |
          set -euo pipefail
          ROOT="${{ steps.unzip.outputs.unzip_dir }}"

          # If single top folder, step into it
          top_dirs=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | wc -l | tr -d ' ')
          top_files=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type f | wc -l | tr -d ' ')
          if [ "$top_dirs" -eq 1 ] && [ "$top_files" -eq 0 ]; then
            ROOT=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1)
          fi

          # Walk down until we see markers
          for i in 1 2 3 4 5; do
            if [ -f "$ROOT/package.json" ] || [ -d "$ROOT/src" ]; then
              break
            fi
            NEXT=$(find "$ROOT" -maxdepth 1 -mindepth 1 -type d | head -n 1 || true)
            if [ -z "$NEXT" ]; then
              break
            fi
            ROOT="$NEXT"
          done

          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "✅ ZIP root: $ROOT"
          ls -la "$ROOT" | head -n 200

      - name: Stage ZIP contents (copy into RUNNER_TEMP stage)
        run: |
          set -euo pipefail
          ROOT="${{ steps.zroot.outputs.root }}"
          STAGE="${{ steps.unzip.outputs.stage_dir }}"

          # Copy everything into stage (stable)
          cp -a "$ROOT/." "$STAGE/"

          # Validate
          test -f "$STAGE/package.json"
          test -d "$STAGE/src"

          echo "✅ Stage ready at: $STAGE"
          ls -la "$STAGE" | head -n 50

      - name: Apply staged files into repo (NO rsync; safe copy)
        run: |
          set -euo pipefail
          STAGE="${{ steps.unzip.outputs.stage_dir }}"

          # Remove everything except .git, .github, imports (and import if you still use it)
          shopt -s dotglob
          for item in * .*; do
            case "$item" in
              "."|".."|".git"|".github"|"imports"|"import") ;;
              *) rm -rf "$item" ;;
            esac
          done
          shopt -u dotglob

          # Copy staged project into repo root
          cp -a "$STAGE/." "./"

          echo "✅ Applied staged files into repo root."

      - name: Install dependencies
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        run: |
          set -euo pipefail
          npm run build

      - name: Commit and push changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Apply CineSafari ZIP update"
          git push
